# Context for Phase 1.4: Add Compaction Resilience to Execute-Phase

## Phase Boundary (from ROADMAP.md)

**Goal:** Make execute-phase survive context compaction during long team-mode executions by adding skill-scoped hooks and EXEC-PROGRESS.md tracking

**Success Criteria:**
1. Execute-phase skill has PreCompact and SessionStart(compact) hooks in frontmatter
2. Execute-phase writes EXEC-PROGRESS.md during execution tracking wave/plan/teammate state
3. cst-help is updated with guidance on compaction resilience and CLAUDE_AUTOCOMPACT_PCT_OVERRIDE

**What's in scope for this phase:**
- Skill-scoped hooks in execute-phase frontmatter
- EXEC-PROGRESS.md write logic in the skill body
- SessionStart hook re-injection of STATE.md, PROJECT.md, EXEC-PROGRESS.md, and current phase PLAN.md files
- cst-help documentation update

**What's explicitly out of scope:**
- Adding compaction resilience to other skills (plan-phase, research-phase)
- Determining ideal CLAUDE_AUTOCOMPACT_PCT_OVERRIDE percentage (will be tested empirically later)
- Global settings changes (env vars stay user-configured)

---

## Codebase Context

**Existing related code:**
- `plugins/claude-super-team/skills/execute-phase/SKILL.md`: The skill to modify (629 lines). Already has resumption logic (Phase 3 checks for SUMMARY.md files to skip completed plans).
- `plugins/claude-super-team/skills/cst-help/SKILL.md`: Help skill that needs a new section on compaction resilience.

**Established patterns:**
- Skill frontmatter uses YAML with fields like `allowed-tools`, `model`, `argument-hint`
- The `hooks` frontmatter field is documented but unused across all skills
- Execute-phase already writes to STATE.md at the end (Phase 8)

**Constraints from existing code:**
- Hook commands in YAML frontmatter are static strings -- they can't reference runtime variables like phase number directly
- Shell commands in hooks can use globs/subshells to find files dynamically
- The skill body is markdown instructions, not executable code -- "write EXEC-PROGRESS.md" is an instruction to Claude, not a script

---

## Cross-Phase Dependencies

**From Phase 1 (Claude Code Capability Mapping)** [executed]:
- ORCHESTRATION-REFERENCE.md: Documents hook system, PreCompact/SessionStart events, and handler types
- CAPABILITY-REFERENCE.md: Confirms `hooks` frontmatter field is documented but unused, and lists CLAUDE_AUTOCOMPACT_PCT_OVERRIDE

---

## Implementation Decisions

### Hook Scope (Files to Re-inject)

**Decision:** Re-inject STATE.md, PROJECT.md, EXEC-PROGRESS.md, and all PLAN.md files for the current phase

**Rationale:** After compaction, the orchestrator needs project context (PROJECT.md), execution state (STATE.md + EXEC-PROGRESS.md), and the plan structures (PLAN.md files) to continue routing tasks. Plans contain task definitions, wave groupings, and must_haves that the orchestrator references throughout execution.

**Constraints:** The hook command must use a glob or subshell to find the current phase's files since the phase directory is dynamic. E.g., `$(ls .planning/phases/*/EXEC-PROGRESS.md 2>/dev/null | tail -1)`.

### Progress File Detail Level

**Decision:** Operational detail -- wave/plan status, team name, teammate assignments, idle teammates, and enough context to resume orchestration without re-reading all summaries

**Rationale:** After compaction, the orchestrator needs to know exactly where it is (current wave), what's done (plan completion status), and what resources are available (teammates and their state). Minimal tracking would force re-discovery of team state which may not be possible from files alone.

**Constraints:** EXEC-PROGRESS.md must be updated after each significant state change (wave start, plan completion, teammate spawn/idle). It's an instruction to the skill, not a script.

---

## Claude's Discretion

- Exact YAML syntax for hooks in skill frontmatter (no existing examples in codebase)
- PreCompact instruction wording (what to preserve vs discard)
- Where in the skill body to insert EXEC-PROGRESS.md write instructions (likely after each wave completion in Phase 5)
- Format and structure of EXEC-PROGRESS.md content

---

## Deferred Ideas

- Testing different CLAUDE_AUTOCOMPACT_PCT_OVERRIDE values (user will test empirically)
- Adding compaction resilience to plan-phase and research-phase (separate effort)
- Using `PreCompact` to dynamically adjust what gets preserved based on execution stage
