---
phase: 01.4-execute-compaction-resilience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/claude-super-team/skills/execute-phase/SKILL.md
  - plugins/claude-super-team/skills/cst-help/SKILL.md
  - plugins/claude-super-team/skills/cst-help/references/workflow-guide.md
  - plugins/claude-super-team/skills/cst-help/references/troubleshooting.md
autonomous: true
quick_phase: true

must_haves:
  truths:
    - Execute-phase SKILL.md frontmatter contains hooks field with PreCompact and SessionStart(compact) handlers that re-inject STATE.md, PROJECT.md, EXEC-PROGRESS.md, and current phase PLAN.md files
    - Execute-phase skill body includes instructions to write and update EXEC-PROGRESS.md during execution with wave/plan status, team name, teammate assignments, and idle teammates
    - cst-help skill, workflow-guide.md, and troubleshooting.md are updated with compaction resilience guidance and CLAUDE_AUTOCOMPACT_PCT_OVERRIDE documentation
  artifacts:
    - plugins/claude-super-team/skills/execute-phase/SKILL.md (modified)
    - plugins/claude-super-team/skills/cst-help/SKILL.md (modified)
    - plugins/claude-super-team/skills/cst-help/references/workflow-guide.md (modified)
    - plugins/claude-super-team/skills/cst-help/references/troubleshooting.md (modified)
  key_links: []
---

<objective>
Add compaction resilience to the execute-phase skill so it survives context compaction during long team-mode executions. This involves three changes: (1) adding skill-scoped PreCompact and SessionStart hooks in frontmatter that re-inject critical state files after compaction, (2) adding EXEC-PROGRESS.md write instructions throughout the execution flow so the orchestrator can resume from compacted state, and (3) updating cst-help with documentation on compaction resilience and CLAUDE_AUTOCOMPACT_PCT_OVERRIDE.

Purpose: Long execute-phase runs with many plans in teams mode can trigger context compaction, causing the orchestrator to lose track of execution state (current wave, teammate assignments, plan completion). This makes execute-phase fragile for large phases.
Output: Modified execute-phase SKILL.md with hooks and progress tracking, updated cst-help files with compaction documentation.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.4-execute-compaction-resilience/01.4-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hooks and EXEC-PROGRESS.md tracking to execute-phase SKILL.md</name>
  <files>plugins/claude-super-team/skills/execute-phase/SKILL.md</files>
  <action>
Modify execute-phase SKILL.md with three changes:

**A) Add `hooks` field to YAML frontmatter.** After the `allowed-tools` line, add a `hooks` field containing two hook definitions:

1. **PreCompact hook** (matcher: `auto`): A command handler that outputs JSON with `additionalContext` containing instructions for the compaction process. The instruction should tell compaction to preserve: current execution state (wave number, plan statuses, teammate names/states), the phase being executed, and the EXEC-PROGRESS.md file path. Use a shell command that reads EXEC-PROGRESS.md and outputs it as additionalContext: `cat .planning/phases/$(ls .planning/phases/ | grep EXEC-PROGRESS | head -1 | xargs -I{} dirname {})/EXEC-PROGRESS.md 2>/dev/null | jq -Rs '{additionalContext: .}' 2>/dev/null || echo '{}'`

2. **SessionStart hook** (matcher: `compact`): A command handler that reads and outputs critical files as additionalContext. The command should concatenate STATE.md, PROJECT.md, EXEC-PROGRESS.md (found via glob), and all PLAN.md files for the current phase (found via glob). Use: `{ echo "=== EXECUTION STATE ==="; cat .planning/STATE.md 2>/dev/null; echo "=== PROJECT ==="; cat .planning/PROJECT.md 2>/dev/null; echo "=== EXEC PROGRESS ==="; cat $(find .planning/phases -name "EXEC-PROGRESS.md" 2>/dev/null | head -1) 2>/dev/null; echo "=== PLANS ==="; cat $(find .planning/phases -name "*-PLAN.md" -path "*$(find .planning/phases -name "EXEC-PROGRESS.md" -exec dirname {} \; 2>/dev/null | head -1)*" 2>/dev/null) 2>/dev/null; } | jq -Rs '{additionalContext: .}'`

The hooks YAML should follow the standard settings.json hook format but in YAML frontmatter. Since no existing skills use hooks, use the documented format from the Claude Code hooks reference: nested under event name, with array of handler objects containing `type`, `command`, and `matcher` fields.

**B) Add EXEC-PROGRESS.md write instructions in the skill body.** Insert a new section "Phase 4.7: Initialize Progress Tracking" between Phase 4.5 (Team Setup) and Phase 5 (Execute Waves) that instructs the orchestrator to create `${PHASE_DIR}/EXEC-PROGRESS.md` with initial state:

```markdown
# Execution Progress: Phase {PHASE}

## Status
- Phase: {PHASE} - {phase_name}
- Mode: {EXEC_MODE}
- Started: {timestamp}
- Current wave: 1

## Team
- Team name: {team_name or "N/A (task mode)"}
- Teammates: (none spawned yet)

## Wave Progress
| Wave | Plans | Status |
|------|-------|--------|
| 1 | {plan_list} | pending |
| 2 | {plan_list} | pending |

## Plan Status
| Plan | Wave | Teammate | Status |
|------|------|----------|--------|
| {plan} | {wave} | - | pending |
```

Then add update instructions at these points in the existing flow:
- **Phase 5 wave loop start**: Update "Current wave" and wave status to "in_progress"
- **Phase 5c teammate spawn** (teams mode): Update teammate column with teammate name
- **Phase 5d/5f plan completion**: Update plan status to "complete" and teammate to "idle"
- **Phase 5g wave completion**: Update wave status to "complete"
- **Phase 5h team cleanup**: Update status to "all waves complete"

Keep the EXEC-PROGRESS.md instructions concise -- one paragraph per update point, not verbose templates. The key data to maintain: current wave, plan statuses, teammate names and states (active/idle), and team name.

**C) Add a note in the Resumption section** (near line 602) mentioning that after compaction, the hooks re-inject EXEC-PROGRESS.md which contains the execution state needed to resume orchestration. The existing resumption logic (checking SUMMARYs) still applies, but EXEC-PROGRESS.md provides finer-grained state within a wave.
  </action>
  <verify>Read the modified SKILL.md and verify: (1) frontmatter has `hooks` field with PreCompact and SessionStart handlers, (2) new "Phase 4.7" section exists with EXEC-PROGRESS.md initialization, (3) update instructions are present at wave start, teammate spawn, plan completion, wave completion, and team cleanup points, (4) Resumption section mentions EXEC-PROGRESS.md.</verify>
  <done>Execute-phase SKILL.md has hooks in frontmatter and EXEC-PROGRESS.md tracking instructions throughout the execution flow. The skill can survive compaction and resume orchestration from the progress file.</done>
</task>

<task type="auto">
  <name>Task 2: Update cst-help skill and references with compaction resilience documentation</name>
  <files>plugins/claude-super-team/skills/cst-help/SKILL.md, plugins/claude-super-team/skills/cst-help/references/workflow-guide.md, plugins/claude-super-team/skills/cst-help/references/troubleshooting.md</files>
  <action>
Update three cst-help files:

**A) SKILL.md** -- In the "Skill Reference" output section (the `/execute-phase` entry around line 397-404), add a bullet point about compaction resilience:
```
  -> Compaction resilient: hooks re-inject execution state after context compaction
  -> Set CLAUDE_AUTOCOMPACT_PCT_OVERRIDE to control when compaction triggers (user-configured)
```

**B) workflow-guide.md** -- Add a new subsection under "Agent Orchestration > Execution" (after the existing bullets around line 203) about compaction resilience:
```
### Compaction Resilience

Long-running `/execute-phase` sessions (especially teams mode with many plans) can trigger context compaction. The skill handles this automatically:

- **PreCompact hook**: Injects EXEC-PROGRESS.md content into the compaction summary so execution state survives
- **SessionStart(compact) hook**: Re-injects STATE.md, PROJECT.md, EXEC-PROGRESS.md, and all PLAN.md files for the current phase after compaction
- **EXEC-PROGRESS.md**: Written to the phase directory during execution; tracks current wave, plan statuses, team name, and teammate assignments

**Configuration:** Set `CLAUDE_AUTOCOMPACT_PCT_OVERRIDE` (1-100) to control when auto-compaction triggers. Lower values compact more aggressively (preserving headroom but losing more context). The ideal value depends on phase size -- test empirically.
```

**C) troubleshooting.md** -- Add a new subsection under "Phase Execution" (after the "Wave dependencies unclear" entry around line 165) with two entries:

1. "Execute-phase lost track after compaction" -- Symptom: orchestrator confused about which wave/plan to execute next after a long run. Cause: context compacted without execution state. Solution: EXEC-PROGRESS.md and hooks handle this automatically in the latest version. If still occurring, check that `CLAUDE_AUTOCOMPACT_PCT_OVERRIDE` is set appropriately.

2. "How to configure compaction threshold" -- Symptom: compaction happens too early or too late during execute-phase. Cause: default threshold may not suit phase size. Solution: Set `CLAUDE_AUTOCOMPACT_PCT_OVERRIDE` environment variable (1-100). Lower values = earlier compaction with more headroom. Start with 50-60 for large phases and adjust based on behavior.

Also update the "When to Use Each Skill" section for `/execute-phase` (around line 450) to add a note: "Compaction resilient: hooks preserve execution state for long-running sessions. Set CLAUDE_AUTOCOMPACT_PCT_OVERRIDE for large phases."
  </action>
  <verify>Read all three files and verify: (1) cst-help SKILL.md mentions compaction resilience in execute-phase entry, (2) workflow-guide.md has "Compaction Resilience" subsection with hook descriptions and CLAUDE_AUTOCOMPACT_PCT_OVERRIDE guidance, (3) troubleshooting.md has two new entries about compaction and the "When to Use" section mentions compaction resilience.</verify>
  <done>The cst-help skill and its reference documents are updated with compaction resilience guidance, hook descriptions, and CLAUDE_AUTOCOMPACT_PCT_OVERRIDE configuration instructions.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify:
1. `plugins/claude-super-team/skills/execute-phase/SKILL.md` has valid YAML frontmatter with `hooks` containing PreCompact and SessionStart handlers
2. Execute-phase body contains Phase 4.7 (Initialize Progress Tracking) and update instructions at 5+ points in the execution flow
3. Execute-phase Resumption section references EXEC-PROGRESS.md
4. `plugins/claude-super-team/skills/cst-help/SKILL.md` references compaction resilience
5. `plugins/claude-super-team/skills/cst-help/references/workflow-guide.md` has Compaction Resilience section
6. `plugins/claude-super-team/skills/cst-help/references/troubleshooting.md` has two new compaction entries and updated "When to Use" section
</verification>

<success_criteria>
Execute-phase skill has PreCompact and SessionStart(compact) hooks in frontmatter that re-inject critical state after compaction. Execute-phase writes and updates EXEC-PROGRESS.md during execution tracking wave/plan completion, team name, and teammate state. cst-help is updated with guidance on compaction resilience and CLAUDE_AUTOCOMPACT_PCT_OVERRIDE configuration.
</success_criteria>

<output>
After completion, create `.planning/phases/01.4-execute-compaction-resilience/01.4-01-SUMMARY.md`
</output>
