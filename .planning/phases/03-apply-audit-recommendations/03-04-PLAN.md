---
phase: 03-apply-audit-recommendations
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/claude-super-team/skills/map-codebase/SKILL.md
  - plugins/claude-super-team/skills/add-security-findings/SKILL.md
autonomous: true

must_haves:
  truths:
    - "map-codebase uses sonnet model instead of opus for its lean orchestrator role"
    - "map-codebase has specific Bash patterns including Bash(rm *) for refresh mode"
    - "add-security-findings no longer has disable-model-invocation: true (auto-invocation enabled)"
    - "add-security-findings has specific Bash pattern instead of blanket Bash"
    - "add-security-findings supports dual-mode operation: autonomous path when auto-invoked, interactive path when user-invoked"
  artifacts:
    - path: "plugins/claude-super-team/skills/map-codebase/SKILL.md"
      provides: "sonnet model + specific Bash patterns including rm for refresh"
    - path: "plugins/claude-super-team/skills/add-security-findings/SKILL.md"
      provides: "Auto-invocation enabled + Bash restricted + dual-mode (autonomous/interactive)"
  key_links:
    - from: "02-AUDIT.md map-codebase model concern"
      to: "map-codebase/SKILL.md model field"
      via: "Downgrade from opus to sonnet (orchestrator is lean, agents do heavy work)"
    - from: "02-AUDIT.md add-security-findings redesign"
      to: "add-security-findings/SKILL.md body"
      via: "Dual-mode entry point that routes based on invocation source"
---

<objective>
Apply changes to the two most complex individual skills: map-codebase (model downgrade + Bash restriction) and add-security-findings (Bash restriction + invocation control change + dual-mode redesign).

Purpose: map-codebase's opus orchestrator is over-specified since agents do the heavy work in sonnet. add-security-findings needs auto-invocation enabled with a dual-mode design to support both autonomous (model-triggered) and interactive (user-invoked) paths.
Output: 2 updated SKILL.md files with corrected models, restricted Bash, and redesigned entry flow for add-security-findings.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-skill-audit-and-reclassification/02-AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix map-codebase model and Bash restriction</name>
  <files>
    plugins/claude-super-team/skills/map-codebase/SKILL.md
  </files>
  <action>
**map-codebase/SKILL.md** -- Edit the YAML frontmatter only. The current frontmatter is:
```yaml
---
name: map-codebase
description: Analyze codebase with parallel mapper agents to produce .planning/codebase/ documents. Use when user wants to understand existing code structure, refresh codebase understanding, onboard to unfamiliar codebase, or before major refactoring. Creates 7 structured documents (STACK, INTEGRATIONS, ARCHITECTURE, STRUCTURE, CONVENTIONS, TESTING, CONCERNS). Supports incremental updates to refresh specific topic areas without rewriting everything.
argument-hint: "[optional: topic to update e.g. 'db and auth', or 'refresh' to remap from scratch]"
context: fork
model: opus
allowed-tools: Read, Bash, Glob, Grep, Write, Task
disable-model-invocation: true
---
```

Replace it with:
```yaml
---
name: map-codebase
description: Analyze codebase with parallel mapper agents to produce .planning/codebase/ documents. Use when user wants to understand existing code structure, refresh codebase understanding, onboard to unfamiliar codebase, or before major refactoring. Creates 7 structured documents (STACK, INTEGRATIONS, ARCHITECTURE, STRUCTURE, CONVENTIONS, TESTING, CONCERNS). Supports incremental updates to refresh specific topic areas without rewriting everything.
argument-hint: "[optional: topic to update e.g. 'db and auth', or 'refresh' to remap from scratch]"
context: fork
model: sonnet
allowed-tools: Read, Glob, Grep, Write, Task, Bash(ls *), Bash(rm *), Bash(mkdir *), Bash(wc *), Bash(grep *)
disable-model-invocation: true
---
```

Two changes:
1. `model: opus` changed to `model: sonnet` -- the orchestrator logic (mode detection, agent spawning, verification) is straightforward. Agents do the heavy analysis in sonnet. No need for opus orchestrator.
2. `allowed-tools` blanket `Bash` replaced with 5 specific patterns:
   - `Bash(ls *)` -- directory listing for mode detection and verification
   - `Bash(rm *)` -- used in refresh mode to clear existing codebase/ directory (`rm -rf .planning/codebase/`)
   - `Bash(mkdir *)` -- create codebase/ directory
   - `Bash(wc *)` -- word/line counts for verification
   - `Bash(grep *)` -- content searching during verification

Note: `Bash(rm *)` is the most permissive pattern in the repository. It is justified because map-codebase's refresh mode deletes `.planning/codebase/` before recreating it. The `context: fork` + `disable-model-invocation: true` combination ensures this only runs in deliberate, isolated contexts.
  </action>
  <verify>
Read map-codebase/SKILL.md and confirm:
- `model: sonnet` (not opus)
- `allowed-tools` contains `Bash(ls *)`, `Bash(rm *)`, `Bash(mkdir *)`, `Bash(wc *)`, `Bash(grep *)` (no blanket Bash)
- `context: fork` preserved
- `disable-model-invocation: true` preserved
- All other fields unchanged
- Skill body completely unchanged
  </verify>
  <done>map-codebase uses sonnet model for lean orchestrator and has 5 specific Bash patterns including rm for refresh mode.</done>
</task>

<task type="auto">
  <name>Task 2: Redesign add-security-findings for dual-mode operation</name>
  <files>
    plugins/claude-super-team/skills/add-security-findings/SKILL.md
  </files>
  <action>
**add-security-findings/SKILL.md** -- Three changes: frontmatter fixes, add dual-mode entry point, and adjust process flow.

**Change 1: Frontmatter fixes**

Replace the current frontmatter:
```yaml
---
name: add-security-findings
description: Store security audit findings in .planning/SECURITY-AUDIT.md and integrate remediation into the project roadmap. Critical/high findings become urgent inserted phases that block feature work. Medium findings become regular phases. Low findings go to backlog. Use after running a security review or audit to document findings and create remediation phases.
allowed-tools: Read, Bash, Write, Edit, AskUserQuestion, Glob, Grep, Skill
disable-model-invocation: true
---
```

With:
```yaml
---
name: add-security-findings
description: Store security audit findings in .planning/SECURITY-AUDIT.md and integrate remediation into the project roadmap. Critical/high findings become urgent inserted phases. Medium findings become regular phases. Low findings go to backlog. Use after a security review or scan, or invoked automatically after security analysis to capture findings.
allowed-tools: Read, Write, Edit, AskUserQuestion, Glob, Grep, Skill, Bash(test *)
---
```

Changes:
- Removed `disable-model-invocation: true` entirely (enables auto-invocation so it can chain after security research/scanning)
- Replaced blanket `Bash` with `Bash(test *)` (only uses `test -f` for file existence checks)
- Updated description to mention auto-invocation use case

**Change 2: Add dual-mode entry point**

Insert a new section immediately after `## Objective` (after the line `**Delegates to:** /create-roadmap for all roadmap modifications`) and before `## Process`. Add:

```markdown

## Mode Detection

This skill supports two invocation modes. Detect which mode applies BEFORE starting the process:

**Interactive mode** (user explicitly invoked `/add-security-findings`):
- Full AskUserQuestion flow for gathering, classifying, and approving findings
- Follow the standard Process below as-is

**Autonomous mode** (model auto-invoked after security analysis/scanning):
- Security findings are already present in the conversation context from prior analysis
- Skip Phase 2 (Gather Findings) -- extract findings directly from conversation context
- Auto-classify severity based on finding content (Critical: RCE/injection/credential exposure, High: auth bypass/privilege escalation, Medium: misconfig/weak policies, Low: informational/outdated deps)
- Present findings summary (Phase 4) with a single approval checkpoint before writing
- Proceed through Phase 5-7 normally

**How to detect mode:**
- If `$ARGUMENTS` is empty AND no security findings are visible in conversation context: Interactive mode
- If security findings are present in conversation context (from a prior scan, research, or analysis): Autonomous mode
- If `$ARGUMENTS` contains a file path or "paste": Interactive mode

```

**Change 3: No changes to the Process section.** The existing Process (Phases 1-7) remains the interactive path. The autonomous mode description above tells the executor how to shortcut through it. This avoids rewriting the entire process flow while enabling dual-mode operation.
  </action>
  <verify>
Read add-security-findings/SKILL.md and confirm:
- No `disable-model-invocation` line in frontmatter (auto-invocation enabled)
- `allowed-tools` contains `Bash(test *)` (no blanket Bash)
- `## Mode Detection` section exists between `## Objective` and `## Process`
- Mode Detection section describes both Interactive and Autonomous modes
- The existing Process section (Phases 1-7) is completely unchanged
- The `## Success Criteria` section at the bottom is unchanged
  </verify>
  <done>add-security-findings enables auto-invocation, uses specific Bash pattern, and has dual-mode design supporting both interactive and autonomous invocation paths.</done>
</task>

</tasks>

<verification>
For both files modified by this plan:
1. map-codebase: `model: sonnet`, 5 specific Bash patterns, no blanket Bash, context: fork and disable-model-invocation preserved
2. add-security-findings: no disable-model-invocation line, Bash(test *) only, Mode Detection section present with dual-mode documentation
3. Neither skill's process logic (phases, steps, bash commands in body) was altered
4. Grep for standalone `Bash` in allowed-tools of both files -- should return zero matches
</verification>

<success_criteria>
map-codebase uses appropriate model (sonnet) with restricted Bash. add-security-findings supports auto-invocation with dual-mode (autonomous/interactive) entry point and restricted Bash. Both skills' core process logic is preserved.
</success_criteria>

<output>
After completion, create `.planning/phases/03-apply-audit-recommendations/03-04-SUMMARY.md`
</output>
