---
phase: 01.2-execute-branch-guard-team-log
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/claude-super-team/skills/execute-phase/SKILL.md
autonomous: true
quick_phase: true

must_haves:
  truths:
    - Execute-phase shows a warning via AskUserQuestion when on the main branch, with options to switch branch or continue
    - Execute-phase prints a simple note (not AskUserQuestion) when git is unavailable or HEAD is detached, and continues
    - Execute-phase logs the team/task mode decision with an explanatory message that tells the user how to change the setting
  artifacts:
    - plugins/claude-super-team/skills/execute-phase/SKILL.md (modified)
  key_links: []
---

<objective>
Add a branch guard and team mode decision logging to the execute-phase skill. The branch guard warns users when executing on the main branch (via AskUserQuestion with override option) and prints a note for detached HEAD or missing git. Team mode logging prints an explanatory message about why task or teams mode was chosen and how to change it.

Purpose: Prevent accidental phase execution on main branch; make execution mode selection transparent.
Output: Modified execute-phase SKILL.md with two new substeps.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.2-execute-branch-guard-team-log/01.2-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add branch guard between Phase 1 and Phase 2</name>
  <files>plugins/claude-super-team/skills/execute-phase/SKILL.md</files>
  <action>
Insert a new "Phase 1.5: Branch Guard" section between the existing Phase 1 (Validate Environment) and Phase 2 (Parse Arguments) in SKILL.md. The section must:

1. Run `git rev-parse --abbrev-ref HEAD 2>/dev/null` to get the current branch.
2. If git is not available or the command fails (exit code != 0), or if HEAD is detached (output is "HEAD"), print a note: "Note: Could not determine branch (git unavailable or detached HEAD). Continuing." and proceed.
3. If the branch is "main" or "master", use AskUserQuestion with:
   - header: "Branch warning"
   - question: "You are on the '{branch}' branch. Running execute-phase on main/master is not recommended."
   - options: "Switch branch" (tell user to switch and re-run, then stop), "Continue anyway" (proceed with execution)
4. Otherwise, proceed normally.
  </action>
  <verify>Read the SKILL.md and confirm Phase 1.5 exists between Phase 1 and Phase 2 with the AskUserQuestion pattern for main/master and the printed note for missing git / detached HEAD.</verify>
  <done>Phase 1.5: Branch Guard section is present in SKILL.md with correct AskUserQuestion flow for main/master and a simple printed note for edge cases.</done>
</task>

<task type="auto">
  <name>Task 2: Add team mode decision logging after execution mode detection</name>
  <files>plugins/claude-super-team/skills/execute-phase/SKILL.md</files>
  <action>
Add a "Phase 2.5: Log Execution Mode Decision" section immediately after Phase 2 (Parse Arguments), which runs once after EXEC_MODE is determined. The section must print one of the following messages based on the mode decision:

- If EXEC_MODE=team and triggered by --team flag: "Using teams mode (--team flag)."
- If EXEC_MODE=team and triggered by environment variable: "Using teams mode (CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1)."
- If EXEC_MODE=task: "Using task mode -- teams not enabled. Pass --team or set CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1 to use teams."

Additionally, add a note that during Phase 5 (Execute Waves), if a wave contains only a single plan and EXEC_MODE=team, downgrade to task mode for that wave and print: "Using task mode for wave {N} -- single plan in wave, teams not beneficial." This is a per-wave note embedded as a bullet or paragraph in the existing Phase 5 wave loop description, not a separate section.

Also update Phase 9 (Done) completion summary to include the execution mode message in its output so the user sees it in the final report.
  </action>
  <verify>Read the SKILL.md and confirm: (1) Phase 2.5 exists after Phase 2 with the three message variants, (2) Phase 5 wave loop mentions single-plan downgrade logging, (3) Phase 9 summary references the execution mode.</verify>
  <done>Team mode decision is logged once at start (Phase 2.5) with explanatory messages including how to change the setting, per-wave single-plan downgrade is noted in Phase 5, and Phase 9 summary reflects the mode.</done>
</task>

</tasks>

<verification>
Read the modified SKILL.md end-to-end. Confirm:
1. Phase 1.5 (Branch Guard) exists between Phase 1 and Phase 2 with AskUserQuestion for main/master and a printed note for detached HEAD / missing git.
2. Phase 2.5 (Log Execution Mode Decision) exists after Phase 2 with three message variants.
3. Phase 5 wave execution mentions single-plan downgrade with a log message.
4. Phase 9 Done section references the execution mode in the completion summary.
5. No existing sections were accidentally removed or reordered.
</verification>

<success_criteria>
The execute-phase SKILL.md contains a branch guard that warns on main/master (with user override via AskUserQuestion) and logs the team/task mode decision with explanatory messages, fulfilling both success criteria from the roadmap.
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-execute-branch-guard-team-log/01.2-01-SUMMARY.md`
</output>
